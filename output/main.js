var app=angular.module("Application",["ngRoute"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"templates/home.html",controller:"homeCtrl"}).when("/theaters",{templateUrl:"templates/theaters.html",controller:"theatersCtrl"}).when("/movies",{templateUrl:"templates/movies.html",controller:"moviesCtrl",resolve:{haveToRefresh:function(Service){return-1===Service.model.previousLocation.indexOf("/movieDetails/")}}}).when("/showtimes/:theaterCode",{templateUrl:"templates/showtimes.html",controller:"showtimesCtrl",resolve:{haveToRefresh:function(Service){return-1===Service.model.previousLocation.indexOf("/movieDetails/")},back:function(Service){return Service.model.previousLocation.indexOf("/movieDetails/")>-1?"#/":Service.model.previousLocation}}}).when("/showtimesByTheater/:searchMode/:movieCode",{templateUrl:"templates/showtimesByTheater.html",controller:"showtimesByTheaterCtrl"}).when("/movieDetails/:movieCode",{templateUrl:"templates/movieDetails.html",controller:"movieDetailsCtrl",resolve:{displayShowtimesButtons:function(Service){return-1===Service.model.previousLocation.indexOf("/showtimes/")},back:function(Service){return Service.model.previousLocation.indexOf("/showtimesByTheater/")>-1?"#/movies":Service.model.previousLocation}}}).otherwise({redirectTo:"/"})}),getConnection=function(){var connection;return connection=0==navigator.connection.type||"none"==navigator.connection.type?!1:!0},window.addEventListener("load",function(){angular.bootstrap(document.body,["Application"])},!1);
app.controller("homeCtrl",function($scope,Model){$scope.model=Model});
app.controller("mainCtrl",function($scope,$location,Service){$scope.model=Service.model,$scope.$on("$locationChangeStart",function(event,current,previous){$scope.model.previousLocation=previous})});
app.controller("movieDetailsCtrl",function($scope,MovieDetails,Model,displayShowtimesButtons,back,$routeParams){$scope.model=Model,$scope.displayShowtimesButtons=displayShowtimesButtons,$scope.back=back,$scope.code=$routeParams.movieCode,MovieDetails.getMovieDetails($scope.code).then(function(){Model.movieDetails.trailer&&Model.movieDetails.trailer.code&&MovieDetails.getTrailer(Model.movieDetails.trailer.code)})});
app.controller("moviesCtrl",function($scope,Movies,Model,haveToRefresh){$scope.model=Model,haveToRefresh&&Movies.getMoviesList()});
app.controller("showtimesCtrl",function($scope,$routeParams,haveToRefresh,back,Service,Showtimes,Model){$scope.model=Model,$scope.back=back,$scope.isFavorite=Model.userSettings.favoriteTheaters.map(function(theater){return theater.code}).indexOf($routeParams.theaterCode)>-1,$scope.toggleFavorite=function(){if($scope.isFavorite)Model.userSettings.favoriteTheaters.push(Model.currentTheater);else{var index=Model.userSettings.favoriteTheaters.indexOf($routeParams.theaterCode);Model.userSettings.favoriteTheaters.splice(index,1)}$scope.isFavorite=!$scope.isFavorite,Service.saveUserSettings()},$scope.nextDay=function(){Model.currentDay+=1},$scope.prevDay=function(){Model.currentDay-=1},haveToRefresh&&Showtimes.getShowtimeList($routeParams.theaterCode)});
app.controller("showtimesByTheaterCtrl",function($scope,$routeParams,Service){$scope.model=Service.model,$scope.code=$routeParams.movieCode,$scope.searchMode=$routeParams.searchMode,$scope.getShowtimesListForAMovie=function(){"gps"===$routeParams.searchMode?navigator.geolocation&&navigator.geolocation.getCurrentPosition?navigator.geolocation.getCurrentPosition($scope.onSuccessGeolocation,$scope.onErrorGeolocation,{maximumAge:0,timeout:1e3,enableHighAccuracy:!0}):$scope.onErrorGeolocation():"favorites"===$routeParams.searchMode&&Service.getShowtimesListForAMovie($routeParams.movieCode,$routeParams.searchMode)},$scope.onSuccessGeolocation=function(position){$scope.model.position={latitude:position.coords.latitude,longitude:position.coords.longitude},Service.getShowtimesListForAMovie($routeParams.movieCode,$routeParams.searchMode)},$scope.onErrorGeolocation=function(){var message="L'activation du GPS est nécessaire afin de trouver les cinémas proposant ce film autour de vous.",title="Activation du GPS",buttonLabels=["Réessayer","Annuler"];navigator.notification.confirm(message,function(index){1===index&&$scope.getShowtimesListForAMovie()},title,buttonLabels)},$scope.nextDay=function(){$scope.model.currentDay+=1},$scope.prevDay=function(){$scope.model.currentDay-=1},$scope.getShowtimesListForAMovie()});
app.controller("theatersCtrl",function($scope,Model,Theaters){$scope.model=Model,$scope.geolocationSearch=function(){try{navigator.geolocation.getCurrentPosition($scope.onSuccessGeolocation,$scope.onErrorGeolocation,Model.geolocationParams)}catch(err){$scope.onErrorGeolocation()}},$scope.onSuccessGeolocation=function(position){Theaters.search("gps",position.coords)},$scope.onErrorGeolocation=function(){navigator.notification.confirm("La recherche géolocalisée nécessite l'activation du GPS.",function(index){1===index&&$scope.geolocationSearch()},"Activation du GPS",["Réessayer","Annuler"])},$scope.onKeyPress=function(e){13===e.charCode&&Theaters.search("text",Model.searchTheaterText)}});
app.factory("Model",function(){return{baseURL:"http://api.allocine.fr/rest/v3",moviesShowtimesForATheater:null,movieDetails:null,movieShowtimesByTheaters:{},nowShowingMovies:null,previousLocation:"/#/",loader:{status:!1,messsage:""},userSettings:JSON.parse(localStorage.userSettings||JSON.stringify({favoriteTheaters:[]})),geolocationParams:{maximumAge:0,timeout:1e3,enableHighAccuracy:!0}}});
app.factory("MovieDetails",function($http,Model,Service){return{getMovieDetails:function(code){return Service.showLoader("Chargement des informations"),$http.get(Model.baseURL+"/movie",Service.getParams({mediafmt:"mp4-lc",profile:"medium",code:code,striptags:"synopsis,synopsisshort"})).then(function(resp){Service.hideLoader(),Model.movieDetails=resp.data.movie},function(){Service.hideLoader()})},getTrailer:function(code){return $http.get(Model.baseURL+"/media",Service.getParams({mediafmt:"mp4-lc",profile:"medium",code:code})).then(function(resp){try{Model.movieDetails.trailer.url=resp.data.media.rendition[0].href}catch(err){Model.movieDetails.trailer.url=void 0}}.bind(this))}}});
app.factory("Movies",function($http,Model,Service){return{getMoviesList:function(){Service.showLoader("Chargement des films"),$http.get(Model.baseURL+"/movielist",Service.getParams({count:50,filter:"nowshowing",order:"toprank"})).then(function(resp){Model.nowShowingMovies=resp.data.feed.movie,Model.nowShowingMovies.forEach(function(movie){movie.poster&&movie.poster.href&&(movie.poster.href=movie.poster.href.replace("/pictures","/r_60_x/pictures"))}),Service.hideLoader()},function(){Service.hideLoader()})}}});
app.service("Service",function($http,Model){this.baseURL="http://api.allocine.fr/rest/v3",this.saveUserSettings=function(){localStorage.userSettings=angular.toJson(this.model.userSettings)},this.showLoader=function(message){this.model.loader.message=message,this.model.loader.status=!0},this.hideLoader=function(){this.model.loader.message="",this.model.loader.status=!1},this.getParams=function(o){return{params:angular.extend({partner:"YW5kcm9pZC12M3M",format:"json"},o)}},this.getShowtimesListForAMovie=function(movieCode,mode){this.showLoader("Chargement des séances");var params={partner:"YW5kcm9pZC12M3M",format:"json",count:30,movie:movieCode};"gps"===mode?(params.radius=30,params.lat=this.model.position.latitude,params["long"]=this.model.position.longitude):"favorites"===mode&&(params.theaters=this.model.userSettings.favoriteTheaters.map(function(theater){return theater.code}).join(",")),$http.get(this.baseURL+"/showtimelist",{params:params}).then(function(resp){this.handleMovieShowtimesListByTheaters(resp.data.feed.theaterShowtimes),this.hideLoader()}.bind(this),function(){this.hideLoader()}.bind(this))},this.getShowtimeVersion=function(movie){var version="Français"===movie.version.$?"VF":"VOSTFR";return movie.screenFormat&&"3D"===movie.screenFormat.$&&(version+=" 3D"),version},this.handleMovieShowtimesListByTheaters=function(theaters){var out={};this.model.currentDay=0,this.model.showtimesDays=[],theaters.forEach(function(item){item.movieShowtimes.forEach(function(movie){movie.scr.forEach(function(day){-1===this.model.showtimesDays.indexOf(day.d)&&this.model.showtimesDays.push(day.d),out[day.d]=out[day.d]||{},void 0===out[day.d][item.place.theater.code]&&(out[day.d][item.place.theater.code]=item.place.theater,out[day.d][item.place.theater.code].showtimes={}),out[day.d][item.place.theater.code].showtimes[this.getShowtimeVersion(movie)]=day.t},this)},this);for(var day in out){var theatersList=[];for(var code in out[day])theatersList.push(out[day][code]);out[day]=theatersList}this.model.movieShowtimesByTheaters=out},this)},localStorage.userSettings=localStorage.userSettings||JSON.stringify({favoriteTheaters:[]}),this.model=Model});
app.factory("Showtimes",function($http,Model,Service){return{getShowtimeList:function(code){Service.showLoader("Chargement des séances"),$http.get(Model.baseURL+"/showtimelist",Service.getParams({profile:"medium",theaters:code})).then(function(resp){Model.currentTheater=resp.data.feed.theaterShowtimes[0].place.theater,this.handleShowtimesList(resp.data.feed.theaterShowtimes[0].movieShowtimes),Service.hideLoader()}.bind(this),function(){Service.hideLoader()})},handleShowtimesList:function(movies){var out={};Model.currentDay=0,Model.showtimesDays=[],movies.forEach(function(movie){movie.scr.forEach(function(day){-1===Model.showtimesDays.indexOf(day.d)&&Model.showtimesDays.push(day.d),out[day.d]=out[day.d]||{},void 0===out[day.d][movie.onShow.movie.title]&&(movie.onShow.movie.poster=movie.onShow.movie.poster||{href:""},out[day.d][movie.onShow.movie.title]={showtimes:{},title:movie.onShow.movie.title,code:movie.onShow.movie.code,thumbnail:movie.onShow.movie.poster.href.replace("/pictures","/r_60_x/pictures"),runtime:movie.onShow.movie.runtime});var version=Service.getShowtimeVersion(movie);out[day.d][movie.onShow.movie.title].showtimes[version]=day.t})}),Model.showtimesDays.sort(),Model.moviesShowtimesForATheater=out}}});
app.factory("Theaters",function($http,Model,Service){return{search:function(mode,search){Service.showLoader("Chargement des cinémas");var params={text:{location:search},gps:{radius:30,lat:search.latitude,lon:search.longitude}};$http.get(Model.baseURL+"/theaterlist",Service.getParams(params[mode])).then(function(resp){Model.theaters=resp.data.feed.theater,Service.hideLoader()},function(){Service.hideLoader()})}}});
app.directive("autofocus",function(){return{restrict:"A",link:function($scope,elements){elements[0].focus()}}});
app.directive("loader",function(){return{restrict:"E",replace:!0,templateUrl:"templates/loader.html",controller:function($scope,Service){$scope.model=Service.model}}});
app.directive("videoPlayer",function(MovieDetails,Model){return{restrict:"E",replace:!0,template:'<video controls="controls"></video>',link:function($scope,$elements,$controller,$attr){var video=$elements[0],source=document.createElement("source");source.src=Model.movieDetails.trailer.url,source.type="video/mp4",video.appendChild(source),video.addEventListener("canplay",function(){video.style.display="inline"})}}});
app.filter("formatDay",function(){return function(input){return moment(input,"YYYY-MM-DD").format("ddd DD MMM")}}).filter("formatRuntime",function(){return function(input){if(!input)return"Durée inconnue";var hours=Math.floor(input/3600),minutes=Math.floor((input-3600*hours)/60);return 10>hours&&(hours="0"+hours),10>minutes&&(minutes="0"+minutes),hours+"h"+minutes}}).filter("formatRelease",function(){return function(input){return"Sortie en salle "+moment(input,"YYYY-MM-DD").fromNow()}}).filter("formatRating",function(){return function(input){return input>4.5?"★★★★★":input>3.5?"★★★★☆":input>2.5?"★★★☆☆":input>1.5?"★★☆☆☆":input>.5?"★☆☆☆☆":"☆☆☆☆☆"}}).filter("formatGenres",function(){return function(input){return input.map(function(genre){return genre.$}).join(", ")}}).filter("formatDistance",function(){return function(input){return input?1>input?1e3*input+" m":input.toFixed(2)+" km":"Distance inconnue"}});